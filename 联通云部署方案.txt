===============================================================================
                    智能报价助手 - 联通云部署方案
===============================================================================

版本: v1.0.0
更新时间: 2024-12-13
适用平台: 中国联通云
项目: React + Node.js + MongoDB 智能报价助手

===============================================================================
                              云资源用途说明
===============================================================================

根据您的联通云控制台，当前拥有的资源及用途：

🖥️ 云服务器 ECS (1台)
   用途: 部署应用程序主体
   - 运行前端React应用 (端口80)
   - 运行AI分析服务器 (端口8080) 
   - 运行MongoDB API服务器 (端口8081)
   - 安装Nginx反向代理

💾 云硬盘 BSS (2个)
   用途: 数据存储和备份
   - 硬盘1: 系统盘 + 应用程序
   - 硬盘2: 数据盘 (上传文件、数据库文件、日志)

🌐 专有网络 VPC (1个)
   用途: 网络安全隔离
   - 创建私有网络环境
   - 配置安全组规则
   - 内网通信优化

🔗 弹性公网IP EIP (1个)
   用途: 外网访问入口
   - 绑定到ECS服务器
   - 配置域名解析
   - HTTPS证书绑定

📊 云数据库 MongoDB (可选)
   用途: 生产级数据库服务
   - 替代本地MongoDB
   - 自动备份和恢复
   - 高可用性保障

===============================================================================
                              推荐部署架构
===============================================================================

方案一: 单服务器部署 (成本低，适合初期)
┌─────────────────────────────────────────┐
│            ECS云服务器                    │
├─────────────────────────────────────────┤
│ Nginx (80/443端口)                      │
│ ├── 静态文件服务 (React构建文件)           │
│ ├── 反向代理到AI服务 (8080端口)           │
│ └── 反向代理到API服务 (8081端口)          │
├─────────────────────────────────────────┤
│ Node.js应用                             │
│ ├── AI分析服务器 (server.js:8080)        │
│ ├── API数据库服务器 (server/app.js:8081) │
│ └── PM2进程管理                         │
├─────────────────────────────────────────┤
│ MongoDB本地数据库 (27017端口)             │
├─────────────────────────────────────────┤
│ 文件存储 (挂载云硬盘)                     │
│ ├── /uploads (用户上传文件)               │
│ ├── /temp_ocr (OCR临时文件)              │
│ └── /logs (应用日志)                     │
└─────────────────────────────────────────┘

方案二: 云数据库分离 (高可用，推荐生产)
┌─────────────────────────────────────────┐
│            ECS云服务器                    │
├─────────────────────────────────────────┤
│ 应用层 (同方案一)                        │
└─────────────────────────────────────────┘
                    ↓ 网络连接
┌─────────────────────────────────────────┐
│          云数据库 MongoDB                 │
├─────────────────────────────────────────┤
│ ✅ 自动备份                              │
│ ✅ 高可用集群                            │
│ ✅ 性能监控                              │
│ ✅ 安全加固                              │
└─────────────────────────────────────────┘

===============================================================================
                              具体操作步骤
===============================================================================

第一步: ECS服务器环境准备
-----------------------
1. 登录ECS服务器 (通过SSH)
   ssh root@您的ECS公网IP

2. 更新系统
   yum update -y  # CentOS
   # 或
   apt update && apt upgrade -y  # Ubuntu

3. 安装基础软件
   # 安装Node.js 18
   curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
   yum install -y nodejs
   
   # 安装MongoDB
   # 参考Ubuntu部署指南.txt中的MongoDB安装步骤
   
   # 安装Nginx
   yum install -y nginx
   
   # 安装PM2
   npm install -g pm2

第二步: 云硬盘挂载配置
-------------------
1. 挂载数据盘到ECS
   # 在联通云控制台操作:
   # ECS实例 → 云硬盘 → 挂载 → 选择数据盘

2. 格式化和挂载硬盘
   # 查看硬盘
   lsblk
   
   # 格式化 (假设是/dev/vdb)
   mkfs.ext4 /dev/vdb
   
   # 创建挂载点
   mkdir -p /data
   
   # 挂载
   mount /dev/vdb /data
   
   # 设置开机自动挂载
   echo '/dev/vdb /data ext4 defaults 0 0' >> /etc/fstab

3. 创建应用目录
   mkdir -p /data/quotation-app
   mkdir -p /data/uploads
   mkdir -p /data/logs
   mkdir -p /data/mongodb

第三步: 项目部署
--------------
1. 上传项目代码
   # 方法1: 使用git
   cd /data/quotation-app
   git clone https://github.com/your-repo/quotation-helper.git
   
   # 方法2: 使用scp上传
   scp -r ./Homepage root@ECS公网IP:/data/quotation-app/

2. 安装依赖
   cd /data/quotation-app/Homepage
   npm install
   
   # 安装服务器端依赖
   cd server
   npm install
   cd ..

3. 构建前端
   npm run build

第四步: 环境变量配置
-----------------
1. 创建主服务器环境变量
   vim /data/quotation-app/Homepage/.env
   
   # 添加内容:
   NODE_ENV=production
   PORT=8080
   UPLOAD_LIMIT=50mb
   
   # 元景AI配置
   YUANJING_API_KEY=sk-your-api-key-here
   YUANJING_MODEL=yuanjing-70b-chat
   YUANJING_API_ENDPOINT=https://maas-api.ai-yuanjing.com/openapi/compatible-mode/v1
   
   # MongoDB配置
   MONGODB_URI=mongodb://localhost:27017/quotation_db

2. 创建API服务器环境变量
   vim /data/quotation-app/Homepage/server/.env
   
   # 添加内容:
   NODE_ENV=production
   PORT=8081
   
   # 数据库配置
   MONGODB_URI=mongodb://localhost:27017/quotation_system
   
   # 跨域配置
   FRONTEND_URL=http://您的域名或IP
   
   # 安全配置
   JWT_SECRET=your-super-secret-jwt-key-change-this
   BCRYPT_ROUNDS=12
   
   # 文件上传配置
   MAX_FILE_SIZE=10485760
   UPLOAD_DIR=/data/uploads

第五步: Nginx配置
---------------
1. 创建Nginx配置文件
   vim /etc/nginx/conf.d/quotation.conf
   
   # 添加内容:
   server {
       listen 80;
       server_name 您的域名或IP;
       
       # 前端静态文件
       location / {
           root /data/quotation-app/Homepage/build;
           try_files $uri $uri/ /index.html;
       }
       
       # AI分析服务代理
       location /api/ {
           proxy_pass http://127.0.0.1:8080;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       # MongoDB API服务代理
       location /api/vendors/ {
           proxy_pass http://127.0.0.1:8081;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
       
       location /api/quotations/ {
           proxy_pass http://127.0.0.1:8081;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
       
       # 文件上传
       location /uploads/ {
           alias /data/uploads/;
       }
   }

2. 启动Nginx
   systemctl start nginx
   systemctl enable nginx

第六步: 启动应用服务
-----------------
1. 使用PM2启动应用
   cd /data/quotation-app/Homepage
   
   # 启动AI分析服务器
   pm2 start server.js --name "ai-server"
   
   # 启动API数据库服务器
   pm2 start server/app.js --name "api-server"
   
   # 查看状态
   pm2 status
   pm2 logs

2. 设置PM2开机自启
   pm2 startup
   pm2 save

第七步: 安全组配置
---------------
在联通云控制台配置安全组规则:

入方向规则:
- HTTP: 80端口 → 0.0.0.0/0
- HTTPS: 443端口 → 0.0.0.0/0  
- SSH: 22端口 → 您的IP地址
- 自定义: 8080端口 → 127.0.0.1 (内网访问)
- 自定义: 8081端口 → 127.0.0.1 (内网访问)

出方向规则:
- 全部流量 → 0.0.0.0/0

第八步: 域名和SSL配置 (可选)
-------------------------
1. 域名解析
   在您的域名服务商处添加A记录:
   @ → 您的ECS公网IP
   www → 您的ECS公网IP

2. SSL证书申请
   # 使用Let's Encrypt免费证书
   yum install -y certbot python3-certbot-nginx
   certbot --nginx -d yourdomain.com -d www.yourdomain.com

===============================================================================
                              测试验证
===============================================================================

部署完成后的测试步骤:

1. 基础连通性测试
   curl http://您的IP或域名
   # 应该返回React应用的HTML

2. API接口测试
   curl http://您的IP或域名/api/health
   # 应该返回健康检查信息

3. 文件上传测试
   # 通过浏览器访问系统，测试Excel/PDF上传功能

4. AI分析测试
   # 上传测试文件，验证AI识别和数据清洗功能

5. 数据库连接测试
   # 检查报价数据是否正确存储和读取

===============================================================================
                              监控和维护
===============================================================================

日常维护命令:
-----------
# 查看应用状态
pm2 status

# 查看应用日志
pm2 logs ai-server
pm2 logs api-server

# 重启应用
pm2 restart ai-server
pm2 restart api-server

# 查看系统资源
htop
df -h

# 查看MongoDB状态
systemctl status mongod

# 备份数据库
mongodump --db quotation_db --out /data/backup/$(date +%Y%m%d)

性能优化建议:
-----------
1. 启用Nginx gzip压缩
2. 配置静态文件缓存
3. 使用CDN加速静态资源
4. 定期清理临时文件和日志
5. 监控服务器资源使用情况

===============================================================================
                              故障排除
===============================================================================

常见问题及解决方案:

1. 应用无法启动
   - 检查端口是否被占用: netstat -tlnp | grep :8080
   - 查看PM2日志: pm2 logs
   - 检查环境变量: cat .env

2. 数据库连接失败
   - 检查MongoDB服务: systemctl status mongod
   - 验证连接字符串: mongo mongodb://localhost:27017/quotation_db
   - 查看防火墙设置: firewall-cmd --list-all

3. 文件上传失败
   - 检查目录权限: ls -la /data/uploads
   - 查看磁盘空间: df -h
   - 检查Nginx配置: nginx -t

4. AI接口调用失败
   - 验证API密钥有效性
   - 检查网络连接
   - 查看API调用日志

===============================================================================
                              联系支持
===============================================================================

技术支持:
- 联通云客服: 10010
- 技术文档: https://www.chinaunicom.com.cn/
- 工单系统: 联通云控制台 → 工单

项目支持:
- 查看项目日志文件
- 联系项目开发团队
- 参考Ubuntu部署指南.txt

=============================================================================== 